<head>
  <style>
    body {
      margin: 0;
    }
  </style>

  <script type="text/javascript" src="./nodes.json"></script>
  <script type="text/javascript" src="./links.json"></script>
  <script src="https://unpkg.com/3d-force-graph"></script>


  <script>
     
     // create nodes utility
    function createNodes(data) {
      const nodes = [{ id: 0, data: data[0] }]
      for (let i = 1; i < data.length; i++) {
        let newNode = {
          id: data[i].id,
          group: Math.ceil(data[i].degree), // for group based on color 
          val: data[i].degree *3, // scaling factor for node size 
          ...data[i] // additonal data 
        }
        nodes.push(newNode)
      }
      return nodes
    }


    // create links utility 
    function createLinks(data) {
      const links = []
      for (let i = 1; i < data.length; i++) {
        let newNode = { source: data[i].source, target: data[i].target }
        links.push(newNode)
      }
      return links
    }


    async function loadDataFiles() {
      
       // load links data json 
      let links = await fetch('./links2.json')
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          return createLinks(data); // parse data as required
        })
        .catch(function (err) {
          console.log('error: ' + err);
        });;

      // load nodes data json file 
      let nodes = await fetch("./nodes_2.json")
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          console.log(data)
          return createNodes(data); // parse nodes data as required
        })
        .catch(function (err) {
          console.log('error: ' + err);
        });;

      return { nodes: nodes, links: links }; // return nodes and links for graph 
    }

    loadDataFiles().then(data => {

      // out of requirement : hover link highlighter 
      // data.links.forEach(link => {
      //   const a = data.nodes[link.source];
      //   const b = data.nodes[link.target];
      //   !a.neighbors && (a.neighbors = []);
      //   !b.neighbors && (b.neighbors = []);
      //   a.neighbors.push(b);
      //   b.neighbors.push(a);

      //   !a.links && (a.links = []);
      //   !b.links && (b.links = []);
      //   a.links.push(link);
      //   b.links.push(link);
      // });

      const highlightNodes = new Set();
      const highlightLinks = new Set();
      let hoverNode = null;

      // create the graph object from the library and 
      const Graph = ForceGraph3D()
        (document.getElementById('graph'))
        .graphData(data) // nodes & links data
        .nodeAutoColorBy('degree') // coluring by peel ()
        .nodeLabel(node => {
          return `<b>Name:${node.id}, degree : ${node.degree}</b>`
        }) // tool tip data
        // .linkWidth(link => link.thickness ) // scaling factor by 10 since we have high values of thickness in the range
        
        // (addtional options)
        .linkOpacity(0.5)
        .linkAutoColorBy(d => d.group) // link color by group (additonal)
        // additonal parameters for link highliting when hovered
      //   .linkDirectionalParticles(link => highlightLinks.has(link) ? 4 : 0)
      //   .linkDirectionalParticleWidth(4)
      //   .onNodeHover(node => {
      //     // no state change
      //     if ((!node && !highlightNodes.size) || (node && hoverNode === node)) return;
      //     highlightNodes.clear();
      //     highlightLinks.clear();
      //     if (node) {
      //       highlightNodes.add(node);
      //       node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
      //       node.links.forEach(link => highlightLinks.add(link));
      //     }

      //     hoverNode = node || null;

      //     updateHighlight();
      //   })
      //   .onLinkHover(link => {
      //     highlightNodes.clear();
      //     highlightLinks.clear();

      //     if (link) {
      //       highlightLinks.add(link);
      //       highlightNodes.add(link.source);
      //       highlightNodes.add(link.target);
      //     }

      //     updateHighlight();
      //   });

      // function updateHighlight() {
      //   // trigger update of highlighted objects in scene
      //   Graph
      //     .nodeColor(Graph.nodeColor())
      //     .linkWidth(Graph.linkWidth())
      //     .linkDirectionalParticles(Graph.linkDirectionalParticles());
      // }
      // ;

    });

  </script>


</head>

<body>
  <div>3d-force graph using Cit patents Data </div>
  <div>Colored by degree</div>
  <div id="graph"></div>
</body>